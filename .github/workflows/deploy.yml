name: ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ“ãƒ«ãƒ‰ã¨CDKãƒ‡ãƒ—ãƒ­ã‚¤

on:
  push:
    branches: [ main ]
    paths:
      - 'contents/slide/slides.md'
  pull_request:
    branches: [ main ]
    paths:
      - 'contents/slide/slides.md'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹

# åŒæ™‚å®Ÿè¡Œã‚’åˆ¶é™ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã®ç«¶åˆã‚’é˜²ã
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

# OIDCãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®æ¨©é™è¨­å®š
permissions:
  id-token: write   # OIDCãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¿…è¦
  contents: read    # ãƒªãƒã‚¸ãƒˆãƒªã®èª­ã¿å–ã‚Šã«å¿…è¦

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # å®Ÿè¡Œæ™‚é–“ã‚’åˆ¶é™ï¼ˆ30åˆ†ï¼‰
    timeout-minutes: 30
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: Node.js 22.xã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
    
    - name: AWSèªè¨¼æƒ…å ±ã‚’è¨­å®šï¼ˆOIDCï¼‰
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        role-session-name: GitHubActions-CDKWorkshop-${{ github.run_id }}
        aws-region: us-east-1
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’çŸ­ãè¨­å®š
        role-duration-seconds: 1800
    
    - name: AWSèªè¨¼æƒ…å ±ã‚’æ¤œè¨¼
      run: |
        aws sts get-caller-identity
        echo "AWSèªè¨¼æƒ…å ±ã®æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸ"
    
    - name: ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci
    
    - name: Slidevãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        cd contents/slide
        npm ci
    
    - name: Slidevã§ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰
      run: |
        cd contents/slide
        echo "=== Slidevãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹ ==="
        npm run build
        echo "=== Slidevãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ ==="
    
    - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ç¢ºèª
      run: |
        echo "=== Slidevãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª ==="
        if [ -d "contents/slide/dist" ]; then
          ls -la contents/slide/dist/
          echo "ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ"
        else
          echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi
    
    - name: Websiteãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        cd website
        npm ci
    
    - name: CDKãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
      run: |
        cd website
        npx cdk --version
        echo "CDKãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸ"
    
    - name: CDKã‚’ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ï¼ˆåˆå›ã®ã¿ï¼‰
      run: |
        cd website
        echo "=== CDKãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ã‚’å®Ÿè¡Œ ==="
        npx cdk bootstrap --require-approval never
        echo "=== CDKãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ ==="
    
    - name: CDKãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆ
      run: |
        cd website
        echo "=== CDKãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆ ==="
        npx cdk synth
        echo "=== CDKãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ ==="
    
    - name: CDKã§Websiteã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
      run: |
        cd website
        echo "=== CDKãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ ==="
        npx cdk deploy --require-approval never --verbose
        echo "=== CDKãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ ==="
    
    - name: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚’å‡ºåŠ›
      run: |
        echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
        echo "ã‚¹ãƒ©ã‚¤ãƒ‰ãŒWebsiteã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸ"
        echo "GitHubã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ­ã‚°ã§Website URLã‚’ç¢ºèªã—ã¦ãã ã•ã„"
    
    - name: ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        echo "è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã¯ä¸Šè¨˜ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        echo "ã‚ˆãã‚ã‚‹å•é¡Œ:"
        echo "- OIDCèªè¨¼ã®è¨­å®šï¼ˆIAMãƒ­ãƒ¼ãƒ«ã®ä¿¡é ¼ãƒãƒªã‚·ãƒ¼ï¼‰"
        echo "- IAMãƒ­ãƒ¼ãƒ«ã®æ¨©é™ä¸è¶³"
        echo "- ãƒªã‚½ãƒ¼ã‚¹åã®ç«¶åˆ"
        echo "- ä¾å­˜é–¢ä¿‚ã®å•é¡Œ"
        echo "- OIDCãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®è¨­å®š"

env:
  # CDKã®è¨­å®š
  CDK_DEFAULT_REGION: us-east-1
  
  # Node.jsã®è¨­å®š
  NODE_OPTIONS: --max_old_space_size=4096
  
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
  AWS_MAX_ATTEMPTS: 3
  AWS_RETRY_MODE: adaptive 